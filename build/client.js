!function(n,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):n.Schnack=t()}(this,function(){"use strict";var C="function"==typeof fetch?fetch.bind():function(r,o){return o=o||{},new Promise(function(n,t){var e=new XMLHttpRequest;for(var a in e.open(o.method||"get",r),o.headers)e.setRequestHeader(a,o.headers[a]);function i(){var a,r=[],o=[],s={};return e.getAllResponseHeaders().replace(/^(.*?):\s*([\s\S]*?)$/gm,function(n,t,e){r.push(t=t.toLowerCase()),o.push([t,e]),a=s[t],s[t]=a?a+","+e:e}),{ok:1==(e.status/200|0),status:e.status,statusText:e.statusText,url:e.responseURL,clone:i,text:function(){return Promise.resolve(e.responseText)},json:function(){return Promise.resolve(e.responseText).then(JSON.parse)},blob:function(){return Promise.resolve(new Blob([e.response]))},headers:{keys:function(){return r},entries:function(){return o},get:function(n){return s[n.toLowerCase()]},has:function(n){return n.toLowerCase()in s}}}}e.withCredentials="include"==o.credentials,e.onload=function(){n(i())},e.onerror=t,e.send(o.body)})};function k(n){var e,a="";return a+='\x3c!-- Comments Template --\x3e\r\n<ul class="comments">\r\n    \x3c!-- handle no posted comments --\x3e\r\n    ',(null==n.comments||n.comments.length<1)&&!n.user&&(a+='\r\n        <div class="no-comments">Be the first to comment on this post.</div>\r\n    '),a+="\r\n\r\n    \x3c!-- iterate comments --\x3e\r\n    ",n.comments.forEach(function(t){a+='\r\n        <li id="comment-'+(null==(e=t.id)?"":e)+'" data-id="'+(null==(e=t.id)?"":e)+'" class="comment ',t.approved||t.trusted||(a+="comment-not-approved"),a+='">\r\n            \x3c!-- Author and date line --\x3e\r\n            <div class="comment-author-dateline">\r\n                <span class="comment-author">',t.author_url&&(a+='<a href="'+(null==(e=t.author_url)?"":e)+'" target="_blank">'),a+=null==(e=t.display_name||t.name)?"":e,t.author_url&&(a+="</a>"),a+="</span>\r\n                ",n.user&&n.user.admin&&!t.trusted&&(a+='\r\n                    <div class="user-admin-actions">\r\n                        ',["trust","block"].forEach(function(n){a+='\r\n                            <button class="btn btn-default btn-action btn-user-admin-action" data-target="'+(null==(e=t.user_id)?"":e)+'" data-class="user" data-action="'+(null==(e=n)?"":e)+'">\r\n                                 <i class="icon icon-action user-action-icon-'+(null==(e=n)?"":e)+'"></i> <span>'+(null==(e=n)?"":e)+"</span>\r\n                            </button>\r\n                            "}),a+="\r\n                    </div>\r\n                    "),a+='\r\n                <span class="comment-date"><a href="#comment-'+(null==(e=t.id)?"":e)+'">'+(null==(e=t.created_at_s)?"":e)+'</a></span>\r\n            </div>\r\n            \x3c!-- Comment body --\x3e\r\n            <div class="comment-body">\r\n                '+(null==(e=t.comment)?"":e)+"\r\n            </div>\r\n            \x3c!-- Comment not approved status and actions --\x3e\r\n            ",t.approved||t.trusted?n.user&&(a+='\r\n                <div class="comment-user-actions">\r\n                    <button class="btn btn-default btn-comment-reply" data-reply-to="'+(null==(e=t.id)?"":e)+'">reply</button>\r\n                    \x3c!-- Admin Actions --\x3e\r\n                    ',n.user&&n.user.admin&&(a+='\r\n                        <button class="btn btn-primary btn-comment-delete" data-comment-id="'+(null==(e=t.id)?"":e)+'">delete</button>\r\n                    '),a+="\r\n                </div>\r\n            "):(a+='\r\n                <div class="comment-awaiting-approval">\r\n                    \x3c!-- Admin View --\x3e\r\n                    ',n.user&&n.user.admin&&(a+='\r\n                        <div class="comment-admin-actions">\r\n                            ',["approve","reject"].forEach(function(n){a+='\r\n                                <button class="btn btn-default btn-action comment-admin-action" data-target="'+(null==(e=t.id)?"":e)+'" data-class="comment" data-action="'+(null==(e=n)?"":e)+'">\r\n                                     <i class="icon icon-action comment-action-icon-'+(null==(e=n)?"":e)+'"></i>\r\n                              </button>\r\n                                '}),a+="\r\n                        </div>\r\n                    "),a+=' \x3c!-- end admin view --\x3e\r\n\r\n                    \x3c!-- Unapproved status text --\x3e\r\n                    <div class="bug">\r\n                            Comment is still waiting for approval by the moderators.\r\n                    </div>\r\n                </div>\r\n                '),a+="\r\n            ",n.replies[t.id]&&(n.comments=n.replies[t.id],a+="\r\n            "+(null==(e=n.comments_template(n))?"":e)+"\r\n        "),a+=" \x3c!-- end for..each --\x3e\r\n        </li>\r\n    "}),a+="\r\n</ul>\r\n"}var T=function(n){return document.querySelector(n)},_=function(n){return document.querySelectorAll(n)},n=function(n){this.options=n,this.options.endpoint=n.host+"/comments/"+n.slug,this.initialized=!1,this.firstLoad=!0;var t=new URL(n.host);"localhost"!==t.hostname&&(document.domain=t.hostname.split(".").slice(1).join(".")),this.refresh()};return n.prototype.refresh=function(){var g=this,n=this.options,x=n.target,w=n.slug,E=n.host,L=n.endpoint;C(L,{credentials:"include",headers:{"Content-Type":"application/json"}}).then(function(n){return n.json()}).then(function(n){n.comments_template=k,T(x).innerHTML=function(t){var e,a="";a+='<div class="comments-ui">\r\n',t.user?(a+="\r\n    \x3c!-- Admin acions --\x3e\r\n    ",t.user.admin&&(a+='\r\n        <div class="admin-settings" style="display:none;">\r\n            <button class="btn btn-action admin-action" data-target="notification" data-class="setting" data-action="true">un</button>\r\n            <button class="btn btn-action admin-action" data-target="notification" data-class="setting" data-action="false">mute notifications</button>\r\n        </div>\r\n    '),a+='\r\n    \x3c!-- User / Authentication --\x3e\r\n    <div class="login-status">\r\n        \x3c!-- Modal dialog to allow user to change display name --\x3e\r\n        <div id="commentDisplayNameChangeModal" class="modal fade" role="dialog">\r\n            <div class="modal-dialog">\r\n                <div class="modal-content">\r\n                    <div class="modal-body">\r\n                        <form>\r\n                            <div class="form-group">\r\n                                <label for="inputCommentDisplayName">Update the display name on your comments:</label>\r\n                                <input type="text" class="form-control updated-name" id="inputCommentDisplayName" aria-describedby="displayNameHelp" value="'+(null==(e=t.user.display_name)?"":e)+'">\r\n                                <small id="displayNameHelp" class="form-text text-muted">\r\n                                Please choose a name to display with your comments. To protect our users, we allow you to use a name different \r\n                                than the real name returned by your authorization service provider. Names should be 3 to 30 characters long, \r\n                                family-friendly and unique. \r\n                                </small>\r\n                            </div>\r\n                        </form>\r\n                    </div>\r\n                    <div class="modal-footer">\r\n                        <button type="btn button" class="btn btn-primary btn-update-name" data-dismiss="modal" id="updateDisplayName">OK</button>\r\n                        <button type="btn button" class="btn btn-default" data-dismiss="modal">Cancel</button>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n        \r\n        <div id="alertUpdateNameFailure" class="alert alert-danger" style="display:none" role="alert">\r\n            <span>Please select a different display name.</span>\r\n        </div>\r\n\r\n        \x3c!-- User display --\x3e\r\n        <span class="commenting-as-label">Commenting as: </span><span class="user">'+(null==(e=t.user.display_name)?"":e)+'</span>\r\n            <span class="user-options" style="float:right">\r\n                <a class="update-name" data-toggle="modal" data-target="#commentDisplayNameChangeModal" href="#">change name</a> | <a class="signout" href="#">sign out</a>\r\n            </span>\r\n    </div>\r\n    \r\n    <div class="comment-entry">\r\n        <div class="comment-form">\r\n            <textarea rows="6" class="post-body" placeholder="enter your comment here..."></textarea>\r\n            <div class="post-preview">\r\n                <div class="post-preview-body" style="display:none"></div>\r\n            </div>\r\n            <button class="btn btn-primary btn-post-comment">Post Comment</button>\r\n            <button class="btn btn-default btn-preview" style="display:none">Preview</button>\r\n            <button class="btn btn-default btn-edit" style="display:none">Edit</button>\r\n            <button class="btn btn-default btn-cancel" style="display:none">Cancel</button>\r\n            <span class="comment-formatting-help"><a href="/comment-formatting/" target="_blank">formatting comments</a></span>\r\n        </div>\r\n    </div>\r\n'):(a+='\r\n    \x3c!-- No user / authentication --\x3e\r\n    <div class="signin">\r\n        <span class="signin-text">Sign in <span class="hidden-sm hidden-xs">with one of the following </span>to comment: </span>\r\n        <div class="signin-providers">\r\n            ',t.auth.forEach(function(n,t){a+='\r\n                <button class="signin-provider signin-'+(null==(e=n.id)?"":e)+'" title="'+(null==(e=n.name)?"":e)+'"><i class="icon signin-icon-'+(null==(e=n.id)?"":e)+'"></i></button>\r\n            '}),a+="\r\n        </div>\r\n    </div>\r\n</div>                        \r\n"),a+="\r\n                    \r\n";var r=[];return t.replies={},t.comments.forEach(function(n){n.reply_to?(t.replies[n.reply_to]||(t.replies[n.reply_to]=[]),t.replies[n.reply_to].push(n)):r.push(n)}),t.comments=r,a+="\r\n"+(null==(e=t.comments_template(t))?"":e)+'\r\n\x3c!-- IMPORTANT - disables click handling on children of buttons --\x3e\r\n<style type="text/css">\r\n    .btn-action > * { pointer-events: none; }\r\n</style>'}(n);var t=T(x+" div.comments-ui"),e=T(x+" div.comment-form"),a=T(x+" textarea.post-body"),r=T(x+" .comment-form .post-preview-body"),o=window.localStorage.getItem("comment-draft-"+w);o&&a&&(a.value=o);var s=T(x+" .btn-post-comment"),i=T(x+" .btn-preview"),l=T(x+" .btn-edit"),c=T(x+" .btn-cancel"),d=_(x+" .btn-comment-reply"),u=_(x+" .btn-comment-delete"),m=T(x+" .btn-update-name"),p=T(x+" #alertUpdateNameFailure"),f=T(x+" .updated-name");if(s&&(s.addEventListener("click",function(n){var t=a.value;C(L,{credentials:"include",method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({comment:t,replyTo:e.dataset.reply})}).then(function(n){return n.json()}).then(function(n){a.value="",window.localStorage.setItem("comment-draft-"+w,a.value),n.id&&(g.firstLoad=!0,window.location.hash="#comment-"+n.id),g.refresh()})}),i.addEventListener("click",function(n){var t=a.value;a.style.display="none",i.style.display="none",r.style.display="block",l.style.display="inline",C(E+"/markdown",{credentials:"include",method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({comment:t})}).then(function(n){return n.json()}).then(function(n){r.innerHTML=n.html})}),l.addEventListener("click",function(n){a.style.display="inline",i.style.display="inline",r.style.display="none",l.style.display="none"}),a.addEventListener("keyup",function(){window.localStorage.setItem("comment-draft-"+w,a.value)}),Array.from(d).forEach(function(n){n.addEventListener("click",function(){e.dataset.reply=n.dataset.replyTo,c.style.display="inline-block",n.parentElement.appendChild(e)})}),m.addEventListener("click",function(){C(E+"/user/name",{credentials:"include",method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:f.value})}).then(function(n){return n.json()}).then(function(n){if(null==n.status||"ok"!=n.status){var t=new Error("failed to update");return Promise.reject(t)}}).then(function(){return g.refresh()}).catch(function(n){p.style.display="block"})}),c.addEventListener("click",function(){t.appendChild(e),delete e.dataset.reply,c.style.display="none"}),Array.from(u).forEach(function(t){t.addEventListener("click",function(){var n=t.dataset.commentId;C(E+"/comment/"+n,{credentials:"include",method:"DELETE"}).then(function(){return g.refresh()})})})),n.user){var h=T("a.signout");h&&h.addEventListener("click",function(n){n.preventDefault(),C(E+"/signout",{credentials:"include"}).then(function(){return g.refresh()})})}else n.auth.forEach(function(e){var n=T(x+" .signin-"+e.id);n&&n.addEventListener("click",function(n){var t=window.open(E+"/auth/"+e.id,e.name+" Sign-In","resizable,scrollbars,status,width=600,height=500");window.__wait_for_oauth=function(){t.close(),g.refresh()}})});if(n.user&&n.user.admin){if(!g.initialized){var y=document.createElement("script");y.setAttribute("src",E+"/push.js"),document.head.appendChild(y),g.initialized=!0}var v=function(n){var t=n.target.dataset;C(E+"/"+t.class+"/"+t.target+"/"+t.action,{credentials:"include",method:"POST",headers:{"Content-Type":"application/json"},body:"{}"}).then(function(){return g.refresh()})};Array.from(document.querySelectorAll(".btn-action")).forEach(function(n){n.addEventListener("click",v)})}if(g.firstLoad&&window.location.hash.match(/^#comment-\d+$/)){var b=document.querySelector(window.location.hash);b.scrollIntoView(),b.classList.add("highlight"),g.firstLoad=!1}})},n});
